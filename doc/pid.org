* [[https://en.wikipedia.org/wiki/PID_controller][PID controller]]

PID controller computes the control value $u(t)$ as a weighted sum of
proportional, integral, and derivative error terms

\[
{\displaystyle u(t)=K_{\text{p}}e(t)+K_{\text{i}}\int _{0}^{t}e(\tau )\,d\tau +K_{\text{d}}{\frac {de(t)}{dt}},}
\]

where $K_{\text{p}}$, $K_{\text{i}}$, and $K_{\text{d}}$, all non-negative, denote
the coefficients for the proportional, integral, and derivative terms.

* Initial parameters tuning

The initial parameter estimation was made with a heuristic [[https://en.wikipedia.org/wiki/PID_controller#Ziegler.E2.80.93Nichols_method][Zieglerâ€“Nichols method]]

| Control Type 	 | $K_{p}$       | 	$K_{i}$                           | $K_{d}$                                |
|-----------------+---------------+-------------------------------------+----------------------------------------|
| P 	            | $0.50{K_{u}}$ | 	-                                 | 	-                                    |
| PI              | $0.45{K_{u}}$ | ${\displaystyle 0.54{K_{u}}/T_{u}}$ | 	-                                    |
| PID             | $0.60{K_{u}}$ | ${\displaystyle 1.2{K_{u}}/T_{u}}$  | 	${\displaystyle 3{K_{u}}{T_{u}}/40}$ |

The ultimate gain $K_u$ is obtained via bisecting $K_p$ parameter finding an approximate value between stable and unstable oscillation
|  $K_u$ | result                |
|      0 | straight              |
|     1. | unstable oscillations |
|    0.5 | stable oscillations   |
|   0.75 | unstable oscillations |
|  0.625 | unstable oscillations |
| 0.5625 | unstable oscillations |
|   0.52 | $K_u$                 |

The final results are $K_u=-0.052$ and the oscillation period $T_u=18$ seconds.

| Control Type 	 | $K_{p}$ | 	$K_{i}$           | $K_{d}$ |
|-----------------+---------+---------------------+---------|
| PID             |   0.312 | 3.466\times 10^{-2} | 	0.702 |

After some  manual parameters adjustments I chose the following values
$K_p=0.2$, $K_i=0.004$, and $K_d= 2.5$.

* Parameters twiddling

These values I used as a starting point for the parameters twiddling procedure explained in the lecture.
The twiddling procedure is implemented in the [[https://github.com/oxidase/CarND-PID-Control-Project/blob/f3e6ec7b72f4b06ac0d95790f1be2e937908a540/src/PID.cpp#L48-L99][PID::Twiddle()] method and represents a variant of the bisection method
for finding minimum of the error function that I defined as
\[
E = \int_0^T e_{\mathrm{cte}}(t)^2 dt \approx \sum_{i=1}^{1400} e_{\mathrm{cte}}_i^2
\]

The twiddling method iterates over $K$ parameters and modifies one parameter per step as $K\pm dK$ while keeping other parameters
constant. If the error per period for the modified parameter is better than the current best one
then the parameter value is saved and $dK$ is increased by the factor 1.25. If both errors for $K\pm dK$ are worse
then the current best error then $dK$ is decreased by the factor 1.25.

After finding the local minimum with $E=208.765$ I have restarted twiddling with initial parameters
$K_p=0.25$, $K_i=5e-3$, and $K_d= 2$.
The second local minimum $K_p=0.238358$, $K_i=0.00788281$, and $K_d=2$ with $E=188.776$.


#+begin_src gnuplot :exports both :file twiddle_error.png
reset

set title "Error"
set xlabel "Step"
set ylabel "Error"

plot 'out.dat' using 0:1 with histeps title 'best error', 'out.dat' using 0:2 with histeps title 'error'
#+end_src

#+results:
[[file:twiddle_error.png]]

#+begin_src gnuplot :exports both :file twiddle_p.png
reset
set title "P coefficient"
set xlabel "Step"
plot 'out.dat' using 0:3 with histeps title 'Kp'
#+end_src

#+results:
[[file:twiddle_p.png]]
#+begin_src gnuplot :exports both :file twiddle_i.png
reset
set title "I coefficient"
set xlabel "Step"
plot 'out.dat' using 0:4 with histeps title 'Ki'
#+end_src

#+results:
[[file:twiddle_i.png]]

#+begin_src gnuplot :exports both :file twiddle_d.png
reset
set title "D coefficient"
set xlabel "Step"
plot 'out.dat' using 0:5 with histeps title 'Kd'
#+end_src

#+results:
[[file:twiddle_d.png]]


This procedure is very simple to implement but very sensitive to local minima,
